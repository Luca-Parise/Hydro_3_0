{% load static l10n %}

<main class="home-site-main">
  <div id="lista-impianti">
    <!-- #region Impianti ATTIVI -->
    <ul id="lista-link-impianti">
      {% for m in misuratori %}
        {% if m.is_active %}
          <a class="impianto-link" href="{% url 'misuratore_detail' m.id_misuratore %}">  
            <li class="impianto-li is-ok">
              {{ m.name }}
            </li>
      </a>

        {% endif %}
      {% endfor %}
    </ul>
    <!-- #endregion -->
    <!-- #region Impianti NON ATTIVI -->
    <ul id="lista-link-impianti-non-attivi">
      {% for m in misuratori %}
        {% if not m.is_active %}
          <a class="lista-link-impianti-non-attivi" href="{% url 'misuratore_detail' m.id_misuratore %}">
            <li class="impianto-li is-off">
              {{ m.name }}
            </li>
          </a>
        {% endif %}
      {% endfor %}
    </ul>
    <!-- #endregion -->
  </div>

  <div class="facility-panel">
    {% if misuratore %}
    <h2 class="facility-title">{{misuratore.name}}</h2>

    <div class="facility-grid">
      <!-- Left column: Info + Stats -->
      <div class="facility-left-column">
        <div class="stats-and-range">
          <div class="facility-stats">
            <h3>Statistiche Portata </h3>
            <table class="facility-table">
              <tbody>
                <tr>
                  <th scope="row">Unita di misura</th>
                  <td colspan="2"><strong>l/s</strong></td>
                </tr>
                <tr>
                  <th scope="row">Ultimo aggiornamento</th>
                  <td colspan="2">{{ misuratore_stats.updated_at|date:"d/m/Y" }}<br />{{ misuratore_stats.updated_at|date:"H:i:s" }}</td>
                </tr>
                <tr>
                  <th scope="row">Media 24h</th>
                  <td>{{misuratore_stats.avg_24h}}</td>
                  
                </tr>
                <tr>
                  <th scope="row">Media 7 giorni</th>
                  <td>{{misuratore_stats.avg_7d}}</td>
                </tr>
                <tr>
                  <th scope="row">Media 30 giorni</th>
                  <td>{{misuratore_stats.avg_30d}}</td>
                </tr>
                <tr>
                  <th scope="row">Media 365 giorni</th>
                  <td>{{misuratore_stats.avg_360d}}</td>
                </tr>
                <tr>
                  <th scope="row">Media totale</th>
                  <td><strong>{{misuratore_stats.avg_all_time}}</strong></td>
                </tr>
                
              </tbody>
            </table>
          </div>
        </div>

        <!-- Dati impianto -->
        {% comment %}
        <div class="facility-info">
          <h3>Informazioni Impianto (misuratore)</h3>
          <table class="facility-table">
            <tbody>
              <tr>
                <th scope="row">Citta</th>
                <td>-</td>
              </tr>
              <tr>
                <th scope="row">CAP</th>
                <td>-</td>
              </tr>
              <tr>
                <th scope="row">Paese</th>
                <td>-</td>
              </tr>
              <tr>
                <th scope="row">Coordinate</th>
                <td>-</td>
              </tr>
              <tr>
                <th scope="row">Stato</th>
                <td class="status-off">Non disponibile</td>
              </tr>
              <tr>
                <th scope="row">Creato il</th>
                <td>-</td>
              </tr>
              <tr>
                <th scope="row">Aggiornato il</th>
                <td>-</td>
              </tr>
            </tbody>
          </table>
        </div>
        {% endcomment %}
      </div>

      <!-- Right column: Plot -->
      <div class="facility-plot">
        <div class="plot-and-range">
          <div class="chart-range chart-range-vertical">
            <button class="range-btn is-active" type="button" data-range="24h">24h</button>
            <button class="range-btn" type="button" data-range="7d">7d</button>
            <button class="range-btn" type="button" data-range="1m">1m</button>
            <button class="range-btn" type="button" data-range="6m">6m</button>
            <button class="range-btn" type="button" data-range="1y">1y</button>
            <button class="range-btn" type="button" data-range="all">all</button>
          </div>
        <!--
        <div class="facility-no-data">
          <strong>Nessun grafico disponibile per questo impianto.</strong><br />
          <span class="facility-no-data-text">
            I dati o il grafico potrebbero essere mancanti.<br />
            Contattare il supporto per chiarimenti.
          </span>
        </div>
        -->
        <div class="facility-plot-grid">
          <div class="chart-card chart-flow-card">
            <div class="chart-actions">
              <button class="chart-zoom" type="button" data-target="chart-flow-rate" aria-label="Zoom grafico portata">+</button>
              <button class="chart-reset" type="button" data-target="chart-flow-rate" aria-label="Reset zoom grafico portata">Reset</button>
            </div>
            <div class="chart-loader" aria-hidden="true">
              <img class="chart-loader-media" src="{% static 'portale/images/hourglass.gif' %}" alt="Caricamento grafico" />
            </div>
            <canvas
              id="chart-flow-rate"
              aria-label="Grafico portata"
              role="img"
              data-misuratore="{{misuratore.id_misuratore}}"
              data-avg-24h="{{ misuratore_stats.avg_24h|unlocalize }}"
              data-avg-7d="{{ misuratore_stats.avg_7d|unlocalize }}"
              data-avg-1m="{{ misuratore_stats.avg_30d|unlocalize }}"
              data-avg-6m=""
              data-avg-1y="{{ misuratore_stats.avg_360d|unlocalize }}"
              data-avg-all="{{ misuratore_stats.avg_all_time|unlocalize }}"
            ></canvas>
          </div>
          <div class="chart-card">
            <div class="chart-actions">
              <button class="chart-zoom" type="button" data-target="chart-fluid-velocity" aria-label="Zoom grafico velocita">+</button>
              <button class="chart-reset" type="button" data-target="chart-fluid-velocity" aria-label="Reset zoom grafico velocita">Reset</button>
            </div>
            <div class="chart-loader" aria-hidden="true">
              <img class="chart-loader-media" src="{% static 'portale/images/loading_circle.gif' %}" alt="Caricamento grafico" />
            </div>
            <canvas
              id="chart-fluid-velocity"
              aria-label="Grafico velocita"
              role="img"
              data-misuratore="{{misuratore.id_misuratore}}"
            ></canvas>
          </div>
          <div class="chart-card">
            <div class="chart-actions">
              <button class="chart-zoom" type="button" data-target="chart-curva-di-durata" aria-label="Zoom grafico curva di durata">+</button>
              <button class="chart-reset" type="button" data-target="chart-curva-di-durata" aria-label="Reset zoom grafico curva di durata">Reset</button>
              <button
                class="chart-info"
                type="button"
                aria-label="Informazioni sul downsampling della curva di durata"
                data-tooltip="Per ogni giorno con dati disponibili è stata calcolata la media; il grafico è costruito su queste medie giornaliere."
                title="Per ogni giorno con dati disponibili è stata calcolata la media; il grafico è costruito su queste medie giornaliere."
              >
                i
              </button>
            </div>
            <div class="chart-loader" aria-hidden="true">
              <img class="chart-loader-media" src="{% static 'portale/images/hourglass.gif' %}" alt="Caricamento grafico" />
            </div>
            <canvas
              id="chart-curva-di-durata"
              aria-label="Grafico curva di durata"
              role="img"
              data-misuratore="{{misuratore.id_misuratore}}"
              data-avg-24h="{{ misuratore_stats.avg_24h|unlocalize }}"
              data-avg-7d="{{ misuratore_stats.avg_7d|unlocalize }}"
              data-avg-1m="{{ misuratore_stats.avg_30d|unlocalize }}"
              data-avg-6m=""
              data-avg-1y="{{ misuratore_stats.avg_360d|unlocalize }}"
              data-avg-all="{{ misuratore_stats.avg_all_time|unlocalize }}"
            ></canvas>
          </div>
        </div>
        </div>
      </div>
    </div>
    {% else %}
    <div class="welcome-message">
      <h2>Benvenuto nel Portale Hydro</h2>
      <p>
        Seleziona un impianto dalla lista a sinistra per visualizzare i dati e
        le statistiche dettagliate.
      </p>
      <p class="welcome-hint">
        Oppure esplora la
        <a href="{% url 'facilities_map' %}">mappa degli impianti</a> per una
        vista d'insieme.
      </p>
    </div>
    {% endif %}
  </div>
</main>
